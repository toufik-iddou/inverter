/*
 * pwm_model.c
 *
 *  Created on: Mar 17, 2024
 *      Author: IDDOU Toufik Islem , BOUKHENNOUFA Mohamed Anis
 */


#include <config/timer_config.h>
#include "controllers/pid_controller.h"
#include "models/pwm_model.h"
#include "system_variables.h"
#include "models/acquisition_model.h"
#include <stdlib.h>
#include "config/dac_config.h"

float duty = 0;
Acquisition_Data data;
static float calculate_Duty_Cycle(float V_ref);
static void PWM_Genearte_GPIO(float duty_cycle);
int16_t pwm  = 0;
//int16_t sin_V_ref2[400]={0};
const float sin_V_ref2[400]={0.000000,5.109068,10.216876,15.322163,20.423668,25.520136,30.610306,35.692924,40.766735,45.830486,50.882931,55.922821,60.948910,65.959961,70.954742,75.932014,80.890549,85.829124,90.746529,95.641541,100.512947,105.359558,110.180176,114.973602,119.738670,124.474182,129.178986,133.851929,138.491837,143.097565,147.667999,152.201981,156.698425,161.156204,165.574219,169.951370,174.286606,178.578827,182.826981,187.030045,191.186951,195.296677,199.358215,203.370575,207.332764,211.243774,215.102676,218.908508,222.660324,226.357193,229.998215,233.582489,237.109131,240.577271,243.986053,247.334641,250.622192,253.847900,257.010986,260.110657,263.146149,266.116699,269.021606,271.860138,274.631592,277.335266,279.970520,282.536682,285.033173,287.459290,289.814514,292.098206,294.309845,296.448853,298.514740,300.506958,302.425018,304.268463,306.036835,307.729706,309.346649,310.887268,312.351166,313.738007,315.047424,316.279114,317.432770,318.508087,319.504852,320.422760,321.261597,322.021179,322.701324,323.301819,323.822571,324.263397,324.624237,324.904968,325.105530,325.225891,325.265991,325.225861,325.105469,324.904846,324.624084,324.263214,323.822327,323.301575,322.701019,322.020844,321.261230,320.422333,319.504395,318.507599,317.432251,316.278564,315.046814,313.737366,312.350494,310.886566,309.345917,307.728943,306.036041,304.267609,302.424133,300.506042,298.513763,296.447876,294.308838,292.097168,289.813416,287.458191,285.032013,282.535522,279.969299,277.334015,274.630310,271.858826,269.020264,266.115326,263.144745,260.109222,257.009521,253.846405,250.620667,247.333084,243.984467,240.575668,237.107498,233.580826,229.996521,226.355469,222.658569,218.906738,215.100891,211.241959,207.330917,203.368713,199.356339,195.294769,191.185013,187.028091,182.825012,178.576828,174.284576,169.949341,165.572159,161.154129,156.696335,152.199875,147.665863,143.095413,138.489670,133.849747,129.176804,124.471977,119.736443,114.971367,110.177925,105.357300,100.510674,95.639252,90.744232,85.826820,80.888237,75.929688,70.952408,65.957626,60.946564,55.920467,50.880569,45.828121,40.764362,35.690548,30.607927,25.517754,20.421284,15.319776,10.214487,5.106679,
		0.000000,-5.109068,-10.216876,-15.322163,-20.423668,-25.520136,-30.610306,-35.692924,-40.766735,-45.830486,-50.882931,-55.922821,-60.948910,-65.959961,-70.954742,-75.932014,-80.890549,-85.829124,-90.746529,-95.641541,-100.512947,-105.359558,-110.180176,-114.973602,-119.738670,-124.474182,-129.178986,-133.851929,-138.491837,-143.097565,-147.667999,-152.201981,-156.698425,-161.156204,-165.574219,-169.951370,-174.286606,-178.578827,-182.826981,-187.030045,-191.186951,-195.296677,-199.358215,-203.370575,-207.332764,-211.243774,-215.102676,-218.908508,-222.660324,-226.357193,-229.998215,-233.582489,-237.109131,-240.577271,-243.986053,-247.334641,-250.622192,-253.847900,-257.010986,-260.110657,-263.146149,-266.116699,-269.021606,-271.860138,-274.631592,-277.335266,-279.970520,-282.536682,-285.033173,-287.459290,-289.814514,-292.098206,-294.309845,-296.448853,-298.514740,-300.506958,-302.425018,-304.268463,-306.036835,-307.729706,-309.346649,-310.887268,-312.351166,-313.738007,-315.047424,-316.279114,-317.432770,-318.508087,-319.504852,-320.422760,-321.261597,-322.021179,-322.701324,-323.301819,-323.822571,-324.263397,-324.624237,-324.904968,-325.105530,-325.225891,-325.265991,-325.225861,-325.105469,-324.904846,-324.624084,-324.263214,-323.822327,-323.301575,-322.701019,-322.020844,-321.261230,-320.422333,-319.504395,-318.507599,-317.432251,-316.278564,-315.046814,-313.737366,-312.350494,-310.886566,-309.345917,-307.728943,-306.036041,-304.267609,-302.424133,-300.506042,-298.513763,-296.447876,-294.308838,-292.097168,-289.813416,-287.458191,-285.032013,-282.535522,-279.969299,-277.334015,-274.630310,-271.858826,-269.020264,-266.115326,-263.144745,-260.109222,-257.009521,-253.846405,-250.620667,-247.333084,-243.984467,-240.575668,-237.107498,-233.580826,-229.996521,-226.355469,-222.658569,-218.906738,-215.100891,-211.241959,-207.330917,-203.368713,-199.356339,-195.294769,-191.185013,-187.028091,-182.825012,-178.576828,-174.284576,-169.949341,-165.572159,-161.154129,-156.696335,-152.199875,-147.665863,-143.095413,-138.489670,-133.849747,-129.176804,-124.471977,-119.736443,-114.971367,-110.177925,-105.357300,-100.510674,-95.639252,-90.744232,-85.826820,-80.888237,-75.929688,-70.952408,-65.957626,-60.946564,-55.920467,-50.880569,-45.828121,-40.764362,-35.690548,-30.607927,-25.517754,-20.421284,-15.319776,-10.214487,-5.106679
};
float V_ref=0;
float If;
float Vo;


float vMax=0;
float vMax2=0;
float pMax=0;
float pMax2=0;
float vRms=0;
int iRms=0;
float pvRms=0;
float vMoy=0;
float pvMoy=0;

float IMax=0;
float IMax2=0;
float IpMax=0;
float IpMax2=0;
float IRms=0;
float pIRms=0;
float IMoy=0;
float pIMoy=0;

float I_ref=0;
float a=1;
void PWM_Generate(void){
	static int i =0;
	static float sum_error =0;
	If= 0.0373 * buffer_adc[0] - 18.95;
//		If= 25.04865*(buffer_adc[1]*3.3/1023) -62.876915;
		float Io=0;
//		Vo= 300*(1.03*(493.34*((buffer_adc[2]*3.3/1023)-1.256)-9)+5.5)/297; our sensor
		Vo=  0.8884*buffer_adc[2] - 457.7;
		float V_error = (30*sin_V_ref2[i]/325.27)-Vo;
		sum_error +=V_error;
		float I_ref = Io + kP_E*V_error + kI_E*TS*sum_error;

//		I_ref = a*sin_V_ref2[i]/325;
		V_ref =(Vo + kP_I*(I_ref - If));
		int16_t duty_cycle = V_ref*(PWM_TIM_period)/V_IN;
		DAC_SetVoltage(1.65+sin_V_ref2[i]/325.27);
//		int16_t duty_cycle = (PWM_TIM_period)*sin_V_ref2[i]/400;
//		int16_t duty_cycle = pwm;
		if(duty_cycle>0){
//			TIM1->CCR1= TIM1->CCR2>>1;
			TIM1->CCR2= duty_cycle;
			TIM1->CCR3= 0;
		}
		else{
//			TIM1->CCR1= TIM1->CCR3>>1;
			TIM1->CCR2= 0;
			TIM1->CCR3= -duty_cycle;
		}
		i=(i+1)%400;
//		pwm=duty_cycle;

		vRms=vRms+Vo*Vo;
		vMoy+=Vo;


		IRms=IRms+If*If;
		IMoy+=If;


		iRms++;

		if(vMax<Vo)
		{
			vMax=Vo;
		}
		if(vMax2>Vo)
			{
			vMax2=Vo;
			}




		if(IMax<If)
		{
			IMax=If;
		}
		if(IMax2>If)
			{
			IMax2=If;
			}

		if(iRms==399){
			pvRms=sqrt(vRms/iRms);
			pvMoy=vMoy/iRms;
			pMax2=vMax2;
			pMax=vMax;
			vMax=0;
			vMoy=0;
			vRms=0;
			vMax2=0;

			pIRms=sqrt(IRms/iRms);
						pIMoy=IMoy/iRms;
						IpMax2=IMax2;
						IpMax=IMax;
						IMax=0;
						IMoy=0;
						IRms=0;
						iRms=0;
						IMax2=0;

		}
//	data = Start_Data_Conversion();
//	float V_ref = calculate_PID_V_ref(data.If,data.Io,data.Vo);
//	float duty_cycle = calculate_Duty_Cycle(V_ref);
//	PWM_Genearte_GPIO(duty_cycle);
}

void PWM_Model_Init(void){
	init_pid_controller();
}

static float calculate_Duty_Cycle(float V_ref){
		return V_ref*PWM_TIM_period/V_IN;
}

static void PWM_Genearte_GPIO(float duty_cycle){
	duty=duty_cycle;
//	TIM1->CCR1 = TIM1->CCR2 == 0 ? (uint16_t) TIM1->CCR3/2 : (uint16_t) TIM1->CCR2/2;
//	TIM1->CCR2 = duty_cycle>0 ? (int16_t)duty_cycle:0;
//	TIM1->CCR3 = duty_cycle>0 ? 0:-(int16_t)duty_cycle;

}


