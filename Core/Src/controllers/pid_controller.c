/*
 * pid_controller.c
 *
 *  Created on: Mar 16, 2024
 *      Author: IDDOU Toufik Islem , BOUKHENNOUFA Mohamed Anis
 */

/* Private includes ----------------------------------------------------------*/
#include "controllers/pid_controller.h"
#include "models/pwm_model.h"
#include <stdbool.h>
#include "config/dac_config.h"
/* Private Constants ----------------------------------------------------------*/
#ifdef PRODUCTION_MODE
const float sin_V_ref[N_ECH]={0.000000f,5.109068f,10.216876f,15.322163f,20.423668f,25.520136f,30.610306f,35.692924f,40.766735f,45.830486f,50.882931f,55.922821f,60.948910f,65.959961f,70.954742f,75.932014f,80.890549f,85.829124f,90.746529f,95.641541f,100.512947f,105.359558f,110.180176f,114.973602f,119.738670f,124.474182f,129.178986f,133.851929f,138.491837f,143.097565f,147.667999f,152.201981f,156.698425f,161.156204f,165.574219f,169.951370f,174.286606f,178.578827f,182.826981f,187.030045f,191.186951f,195.296677f,199.358215f,203.370575f,207.332764f,211.243774f,215.102676f,218.908508f,222.660324f,226.357193f,229.998215f,233.582489f,237.109131f,240.577271f,243.986053f,247.334641f,250.622192f,253.847900f,257.010986f,260.110657f,263.146149f,266.116699f,269.021606f,271.860138f,274.631592f,277.335266f,279.970520f,282.536682f,285.033173f,287.459290f,289.814514f,292.098206f,294.309845f,296.448853f,298.514740f,300.506958f,302.425018f,304.268463f,306.036835f,307.729706f,309.346649f,310.887268f,312.351166f,313.738007f,315.047424f,316.279114f,317.432770f,318.508087f,319.504852f,320.422760f,321.261597f,322.021179f,322.701324f,323.301819f,323.822571f,324.263397f,324.624237f,324.904968f,325.105530f,325.225891f,325.265991f,325.225861f,325.105469f,324.904846f,324.624084f,324.263214f,323.822327f,323.301575f,322.701019f,322.020844f,321.261230f,320.422333f,319.504395f,318.507599f,317.432251f,316.278564f,315.046814f,313.737366f,312.350494f,310.886566f,309.345917f,307.728943f,306.036041f,304.267609f,302.424133f,300.506042f,298.513763f,296.447876f,294.308838f,292.097168f,289.813416f,287.458191f,285.032013f,282.535522f,279.969299f,277.334015f,274.630310f,271.858826f,269.020264f,266.115326f,263.144745f,260.109222f,257.009521f,253.846405f,250.620667f,247.333084f,243.984467f,240.575668f,237.107498f,233.580826f,229.996521f,226.355469f,222.658569f,218.906738f,215.100891f,211.241959f,207.330917f,203.368713f,199.356339f,195.294769f,191.185013f,187.028091f,182.825012f,178.576828f,174.284576f,169.949341f,165.572159f,161.154129f,156.696335f,152.199875f,147.665863f,143.095413f,138.489670f,133.849747f,129.176804f,124.471977f,119.736443f,114.971367f,110.177925f,105.357300f,100.510674f,95.639252f,90.744232f,85.826820f,80.888237f,75.929688f,70.952408f,65.957626f,60.946564f,55.920467f,50.880569f,45.828121f,40.764362f,35.690548f,30.607927f,25.517754f,20.421284f,15.319776f,10.214487f,5.106679f,
		0.000000f,-5.109068f,-10.216876f,-15.322163f,-20.423668f,-25.520136f,-30.610306f,-35.692924f,-40.766735f,-45.830486f,-50.882931f,-55.922821f,-60.948910f,-65.959961f,-70.954742f,-75.932014f,-80.890549f,-85.829124f,-90.746529f,-95.641541f,-100.512947f,-105.359558f,-110.180176f,-114.973602f,-119.738670f,-124.474182f,-129.178986f,-133.851929f,-138.491837f,-143.097565f,-147.667999f,-152.201981f,-156.698425f,-161.156204f,-165.574219f,-169.951370f,-174.286606f,-178.578827f,-182.826981f,-187.030045f,-191.186951f,-195.296677f,-199.358215f,-203.370575f,-207.332764f,-211.243774f,-215.102676f,-218.908508f,-222.660324f,-226.357193f,-229.998215f,-233.582489f,-237.109131f,-240.577271f,-243.986053f,-247.334641f,-250.622192f,-253.847900f,-257.010986f,-260.110657f,-263.146149f,-266.116699f,-269.021606f,-271.860138f,-274.631592f,-277.335266f,-279.970520f,-282.536682f,-285.033173f,-287.459290f,-289.814514f,-292.098206f,-294.309845f,-296.448853f,-298.514740f,-300.506958f,-302.425018f,-304.268463f,-306.036835f,-307.729706f,-309.346649f,-310.887268f,-312.351166f,-313.738007f,-315.047424f,-316.279114f,-317.432770f,-318.508087f,-319.504852f,-320.422760f,-321.261597f,-322.021179f,-322.701324f,-323.301819f,-323.822571f,-324.263397f,-324.624237f,-324.904968f,-325.105530f,-325.225891f,-325.265991f,-325.225861f,-325.105469f,-324.904846f,-324.624084f,-324.263214f,-323.822327f,-323.301575f,-322.701019f,-322.020844f,-321.261230f,-320.422333f,-319.504395f,-318.507599f,-317.432251f,-316.278564f,-315.046814f,-313.737366f,-312.350494f,-310.886566f,-309.345917f,-307.728943f,-306.036041f,-304.267609f,-302.424133f,-300.506042f,-298.513763f,-296.447876f,-294.308838f,-292.097168f,-289.813416f,-287.458191f,-285.032013f,-282.535522f,-279.969299f,-277.334015f,-274.630310f,-271.858826f,-269.020264f,-266.115326f,-263.144745f,-260.109222f,-257.009521f,-253.846405f,-250.620667f,-247.333084f,-243.984467f,-240.575668f,-237.107498f,-233.580826f,-229.996521f,-226.355469f,-222.658569f,-218.906738f,-215.100891f,-211.241959f,-207.330917f,-203.368713f,-199.356339f,-195.294769f,-191.185013f,-187.028091f,-182.825012f,-178.576828f,-174.284576f,-169.949341f,-165.572159f,-161.154129f,-156.696335f,-152.199875f,-147.665863f,-143.095413f,-138.489670f,-133.849747f,-129.176804f,-124.471977f,-119.736443f,-114.971367f,-110.177925f,-105.357300f,-100.510674f,-95.639252f,-90.744232f,-85.826820f,-80.888237f,-75.929688f,-70.952408f,-65.957626f,-60.946564f,-55.920467f,-50.880569f,-45.828121f,-40.764362f,-35.690548f,-30.607927f,-25.517754f,-20.421284f,-15.319776f,-10.214487f,-5.106679f
};
#endif
/* Private Variables ----------------------------------------------------------*/
#ifdef DEVELOPMENT_MODE
float sin_V_ref[400];
#endif
uint8_t sin_ref_index=-1;
bool sin_ref_signe=false;
float sum_V_error=0;
/* Private Functions ----------------------------------------------------------*/
/*	initialization	*/

static void init_sin_V_ref();

void pid_controller_Init();
/*	calculation	*/
static void caclulate_sin_ref_index(void);
static float calculate_V_error(float Vo);
static float calculate_if_ref(float Io,float Vo,float V_error);
static float calculate_V_ref(float Vo,float If,float I_ref);

/*
 * code begin
 */

#ifdef DEVELOPMENT_MODE
static void init_sin_V_ref(){
 	for ( int i=0;i<=N_ECH;i++){
 		sin_V_ref[i]=(V_REF_MAX*sin(i*2*PI/(N_ECH)));
 	}
}
#endif

void init_pid_controller(){

#ifdef DEVELOPMENT_MODE
	init_sin_V_ref();
#endif

}


static void caclulate_sin_ref_index(){
	static int8_t sin_ref_index_direction=1;
	if(sin_ref_index==0){
		sin_ref_index_direction = 1;
		sin_ref_signe=!sin_ref_signe;
	}
	if(sin_ref_index==100){
		sin_ref_index_direction = -1;
	}
	sin_ref_index+=sin_ref_index_direction;

}

static float calculate_V_error(float Vo){
	float error = sin_ref_signe ? (sin_V_ref[sin_ref_index])-Vo : (-sin_V_ref[sin_ref_index])-Vo;
	sum_V_error += error;
	return error;
}

static float calculate_if_ref(float Vo,float Io,float V_error){	// voltage loop
	return (Io + kP_E*V_error + kI_E*TS*sum_V_error);
}

static float calculate_V_ref(float Vo,float If,float I_ref){	// current loop
	return (Vo + kP_I*(I_ref - If));
}

float Vout ;

float calculate_PID_V_ref(float If,float Io,float Vo){
	caclulate_sin_ref_index();
	float V_error = calculate_V_error(Vo);
	float I_ref = calculate_if_ref(Vo,Io,V_error);
	float V_ref =  calculate_V_ref(Vo,If,I_ref);
//	if(sin_ref_signe){
//		Vout = (float) (1.5*sin_V_ref[sin_ref_index]/(V_REF_MAX))+1.5;
//
//		}else{
//			Vout =- (float) (1.5*sin_V_ref[sin_ref_index]/(V_REF_MAX))+1.5;
//		}
		DAC_SetValue(Io,DAC_CHANNEL_1);
	return V_ref;
}
